<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>
<link rel="stylesheet" href="style.css">
<style>
  .messages-area {
    max-height: 400px;
    overflow-y: auto;
    padding: 10px;
    background: #222;
  }
  .message {
    display: flex;
    margin-bottom: 6px;
    align-items: flex-start;
  }
  .message img {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    margin-right: 8px;
  }
  .message-content {
    flex: 1;
    border-radius: 5px;
    padding: 6px 10px;
    background: #333;
  }
  .message .user {
    font-weight: bold;
  }
  #typing-indicator {
    font-style: italic;
    opacity: 0.7;
    margin: 4px 10px;
  }
</style>
</head>
<body>
<div class="chat-container">
  <header>
    <h1 class="dancing"> I mÎ¹Ñ•Ñ• yÎ¿Ï… </h1>
  </header>

  <div id="chat-messages" class="messages-area"></div>
  <div id="typing-indicator"></div>

<form id="chat-form" novalidate>
  <input type="text" id="username" placeholder="Seu nome">
  <input type="file" id="image-input" accept="image/*">
  <div class="input-group">
    <input type="text" id="message-input" placeholder="Digite sua mensagem...">
    <button type="submit">Enviar</button>
    <!-- BotÃ£o para gravar Ã¡udio -->
    <button type="button" id="record-btn">ðŸŽ¤ Gravar</button>
  </div>
</form>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";
import { 
  getDatabase, ref, push, onChildAdded, serverTimestamp, set, onDisconnect, onValue 
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

document.addEventListener('DOMContentLoaded', () => {

  const notificationSound = new Audio('som.mp3');
  const typingSound = new Audio('typing.mp3');
  typingSound.volume = 0.3;

  const firebaseConfig = {
    apiKey: "AIzaSyBuiBi8B3Sf6hZfLOYd9Ezl6IXw8NbbF1A",
    authDomain: "mextill.firebaseapp.com",
    databaseURL: "https://mextill-default-rtdb.firebaseio.com",
    projectId: "mextill",
    storageBucket: "mextill.firebasestorage.app",
    messagingSenderId: "811140414542",
    appId: "1:811140414542:web:e695c35ec6d0cdf523571f",
    measurementId: "G-7D3J6PQVZM"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const storage = getStorage(app); // Storage aqui
  const messagesRef = ref(db, 'messages');
  const connectedRef = ref(db, ".info/connected");
  const typingRef = ref(db, 'typing');

  const chatForm = document.getElementById('chat-form');
  const messageInput = document.getElementById('message-input');
  const usernameInput = document.getElementById('username');
  const messagesArea = document.getElementById('chat-messages');
  const typingIndicator = document.getElementById('typing-indicator');
  const imageInput = document.getElementById('image-input');

  const defaultPhoto = 'foto3.jpg'; // fallback / terceira foto

  // FunÃ§Ã£o para gerar cor Ãºnica baseada no nome (para borda)
  function getUserColor(username) {
    let hash = 0;
    for (let i = 0; i < username.length; i++) hash = username.charCodeAt(i) + ((hash << 5) - hash);
    return `hsl(${hash % 360}, 70%, 60%)`;
  }

  // Escolher GIF/avatar baseado no username
  function getPhotoByUsername(username) {
    if (username === "Disteseach" || username === "disteseach") return 'aladin.gif';
    if (username === "NID" || username === "nid" || username === "Nid") return 'disney.gif';
    return 'disney.gif'; // qualquer outro usuÃ¡rio
  }

  function activateUserStatus(username) {
    const userStatusRef = ref(db, 'users/' + username);
    onValue(connectedRef, snap => {
      if (snap.val() === true) {
        set(userStatusRef, { online: true, lastSeen: serverTimestamp() });
        onDisconnect(userStatusRef).update({ online: false, lastSeen: serverTimestamp() });
      }
    });
  }

  const savedName = localStorage.getItem('chat_username');
  if (savedName) {
    usernameInput.value = savedName;
    usernameInput.readOnly = true;
    usernameInput.style.opacity = "0.6";
    activateUserStatus(savedName);
  }

  // FunÃ§Ã£o para enviar mensagens de texto
  chatForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const message = messageInput.value.trim();
    const username = usernameInput.value.trim();
    if (!username) { alert("Digite seu nome."); return; }
    if (!message) return;

    if (!savedName) {
      localStorage.setItem('chat_username', username);
      usernameInput.readOnly = true;
      usernameInput.style.opacity = "0.6";
      activateUserStatus(username);
    }

    push(messagesRef, {
      username,
      text: message,
      timestamp: serverTimestamp()
    });

    messageInput.value = '';
    set(ref(db, `typing/${username}`), false);
  });

  // BotÃ£o de gravar Ã¡udio
  const recordBtn = document.getElementById('record-btn');
  let mediaRecorder;
  let audioChunks = [];

  function uploadAudio(blob, username) {
    const fileRef = storageRef(storage, `audios/${username}_${Date.now()}.webm`);
    uploadBytes(fileRef, blob)
      .then(() => getDownloadURL(fileRef))
      .then(url => {
        push(messagesRef, {
          username,
          audioURL: url,
          timestamp: serverTimestamp()
        });
      })
      .catch(err => console.error("Erro ao enviar Ã¡udio:", err));
  }

  recordBtn.addEventListener('click', async () => {
    if (!mediaRecorder || mediaRecorder.state === "inactive") {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = async () => {
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        audioChunks = [];
        uploadAudio(blob, usernameInput.value);
      };

      mediaRecorder.start();
      recordBtn.textContent = "â¹ï¸ Parar";
    } else if (mediaRecorder.state === "recording") {
      mediaRecorder.stop();
      recordBtn.textContent = "ðŸŽ¤ Gravar";
    }
  });

  // FunÃ§Ã£o para enviar imagens
  function uploadImage(file, username) {
    const fileRef = storageRef(storage, `images/${username}_${Date.now()}_${file.name}`);
    uploadBytes(fileRef, file)
      .then(() => getDownloadURL(fileRef))
      .then(url => {
        push(messagesRef, {
          username,
          imageURL: url,
          timestamp: serverTimestamp()
        });
      })
      .catch(err => console.error("Erro ao enviar imagem:", err));
  }

  imageInput.addEventListener('change', () => {
    const file = imageInput.files[0];
    if (!file) return;
    const username = usernameInput.value.trim();
    if (!username) {
      alert("Digite seu nome antes de enviar uma imagem!");
      return;
    }
    uploadImage(file, username);
    imageInput.value = "";
  });

  // Status online/offline
  const userStatusRefs = {};
  function monitorUserStatus(username, statusDiv) {
    if (userStatusRefs[username]) return;
    const statusRef = ref(db, 'users/' + username);
    onValue(statusRef, snapshot => {
      const userData = snapshot.val();
      if (!userData) return;
      if (userData.online) statusDiv.innerHTML = "ðŸŸ¢ Online";
      else if (userData.lastSeen) {
        const date = new Date(userData.lastSeen);
        statusDiv.innerHTML = "Visto Ã s " + date.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
      }
    });
    userStatusRefs[username] = true;
  }

  // Exibir mensagens
  onChildAdded(messagesRef, (data) => {
    const msg = data.val();
    if (!msg) return;

    const messageElement = document.createElement('div');
    messageElement.classList.add('message');

    let time = "--:--";
    if (msg.timestamp) time = new Date(msg.timestamp).toLocaleTimeString('pt-BR',{hour:'2-digit', minute:'2-digit'});

    const userColor = getUserColor(msg.username);
    const photoURL = getPhotoByUsername(msg.username);

    messageElement.innerHTML = `
      <img src="${photoURL}" alt="avatar">
      <div class="message-content" style="border-left:4px solid ${userColor}; padding-left:8px;">
        <div style="display:flex; justify-content:space-between; align-items:baseline;">
          <span class="user" style="font-weight:bold; color:${userColor};">${msg.username}</span>
          <span style="font-size:0.7rem; opacity:0.6;">${time}</span>
        </div>
        <div style="color:#fff;">
          ${msg.text || ""}
          ${msg.audioURL ? `<audio controls src="${msg.audioURL}"></audio>` : ""}
          ${msg.imageURL ? `<img src="${msg.imageURL}" style="max-width:200px; display:block; margin-top:5px;">` : ""}
        </div>
        <div class="status" style="font-size:0.65rem; opacity:0.7;"></div>
      </div>
    `;

    messagesArea.appendChild(messageElement);
    messagesArea.scrollTo({ top: messagesArea.scrollHeight, behavior: 'smooth' });

    if (msg.username !== usernameInput.value && Notification.permission === "granted" && document.hidden) {
      new Notification(`Nova mensagem de ${msg.username}`, { body: msg.text });
      notificationSound.play().catch(() => {});
    }

    const statusDiv = messageElement.querySelector(".status");
    monitorUserStatus(msg.username, statusDiv);
  });

  // DigitaÃ§Ã£o
  let typingTimeout;
  messageInput.addEventListener('input', () => {
    const username = usernameInput.value.trim();
    if (!username) return;
    set(ref(db, `typing/${username}`), true);
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => set(ref(db, `typing/${username}`), false), 2000);
  });

  onValue(typingRef, (snapshot) => {
    const typingData = snapshot.val() || {};
    const otherUsersTyping = Object.keys(typingData)
      .filter(user => user !== usernameInput.value && typingData[user] === true);
    if (otherUsersTyping.length > 0) {
      typingIndicator.textContent = otherUsersTyping.length === 1 
        ? `${otherUsersTyping[0]} estÃ¡ digitando...`
        : `${otherUsersTyping.join(", ")} estÃ£o digitando...`;
      typingSound.play().catch(() => {});
    } else {
      typingIndicator.textContent = "";
    }
  });

});

</script>
</body>
</html>
