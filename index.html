<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="chat-container">
        <header>
            <h1>Chat</h1>
        </header>
        <div id="chat-messages" class="messages-area">
            <!-- As mensagens aparecer칚o aqui -->
        </div>
        <form id="chat-form" novalidate>
            <input type="text" id="username" placeholder="Seu nome">
            <div class="input-group">
                <input type="text" id="message-input" placeholder="Digite sua mensagem...">
                <button type="submit">Enviar</button>
            </div>
        </form>
    </div>

    <!-- Firebase SDK -->
<script type="module">
  // 游댠 IMPORTS FIREBASE (sempre no topo do m칩dulo)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { 
    getDatabase, 
    ref, 
    push, 
    onChildAdded, 
    serverTimestamp,
    set,
    onDisconnect,
    onValue
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

  document.addEventListener('DOMContentLoaded', () => {

    // 游댒 Permiss칚o para notifica칞칫es
    if (Notification.permission === "default") {
      Notification.requestPermission().then(permission => {
        console.log("Permiss칚o de notifica칞칚o:", permission);
      });
    }

    // Som da notifica칞칚o
    const notificationSound = new Audio('som.mp3');

    // 游댠 CONFIG FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyBuiBi8B3Sf6hZfLOYd9Ezl6IXw8NbbF1A",
  authDomain: "mextill.firebaseapp.com",
  databaseURL: "https://mextill-default-rtdb.firebaseio.com",
  projectId: "mextill",
  storageBucket: "mextill.firebasestorage.app",
  messagingSenderId: "811140414542",
  appId: "1:811140414542:web:e695c35ec6d0cdf523571f",
  measurementId: "G-7D3J6PQVZM"
};

    // 游댠 INICIALIZAR
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const messagesRef = ref(db, 'messages');
    const connectedRef = ref(db, ".info/connected");

    // 游댳 ELEMENTOS DOM
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const usernameInput = document.getElementById('username');
    const messagesArea = document.getElementById('chat-messages');

    // =============================
    // 游댠 ATIVAR STATUS ONLINE REAL
    // =============================
    function activateUserStatus(username) {
      const userStatusRef = ref(db, 'users/' + username);

      onValue(connectedRef, (snap) => {
        if (snap.val() === true) {
          // Marca online
          set(userStatusRef, {
            online: true,
            lastSeen: serverTimestamp()
          });

          // Quando desconectar
          onDisconnect(userStatusRef).update({
            online: false,
            lastSeen: serverTimestamp()
          });
        }
      });
    }

    // =============================
    // 游댠 CARREGAR NOME SALVO
    // =============================
    const savedName = localStorage.getItem('chat_username');

    if (savedName) {
      usernameInput.value = savedName;
      usernameInput.readOnly = true;
      usernameInput.style.opacity = "0.6";
      activateUserStatus(savedName);
    }

    // =============================
    // 游댠 ENVIAR MENSAGEM
    // =============================
    chatForm.addEventListener('submit', (e) => {
      e.preventDefault();

      const message = messageInput.value.trim();
      const username = usernameInput.value.trim();

      if (!username) {
        alert("Por favor, digite seu nome.");
        return;
      }

      if (!message) return;

      // Salvar nome e ativar status
      if (!savedName) {
        localStorage.setItem('chat_username', username);
        usernameInput.readOnly = true;
        usernameInput.style.opacity = "0.6";
        activateUserStatus(username);
      }

      push(messagesRef, {
        username: username,
        text: message,
        timestamp: serverTimestamp()
      });

      messageInput.value = '';
    });

    // =============================
    // 游댠 MONITORAR STATUS DE USU츼RIOS (칔NICO LISTENER POR USU츼RIO)
    // =============================
    const userStatusRefs = {};

    function monitorUserStatus(username, statusDiv) {
      if (userStatusRefs[username]) return; // j치 monitorando

      const statusRef = ref(db, 'users/' + username);
      onValue(statusRef, (snapshot) => {
        const userData = snapshot.val();
        if (!userData) return;

        if (userData.online) {
          statusDiv.innerHTML = "游릭 Online";
        } else if (userData.lastSeen) {
          const date = new Date(userData.lastSeen);
          statusDiv.innerHTML = "Visto 맙 " + date.toLocaleTimeString('pt-BR', {
            hour: '2-digit',
            minute: '2-digit'
          });
        }
      });

      userStatusRefs[username] = true;
    }

    // =============================
    // 游댠 RECEBER MENSAGENS
    // =============================
    onChildAdded(messagesRef, (data) => {

      const msg = data.val();
      if (!msg) return;

      const messageElement = document.createElement('div');
      messageElement.classList.add('message');

      let time = "--:--";
      if (msg.timestamp) {
        const date = new Date(msg.timestamp);
        time = date.toLocaleTimeString('pt-BR', {
          hour: '2-digit',
          minute: '2-digit'
        });
      }

const userColor = getUserColor(msg.username);

messageElement.innerHTML = `
  <div style="display:flex; justify-content:space-between; align-items:baseline;">
    <div>
      <span class="user" style="font-weight:bold; color:${userColor};">
        ${msg.username}
      </span>
      <div class="status" style="font-size:0.65rem; opacity:0.7;"></div>
    </div>
    <span style="font-size:0.7rem; opacity:0.6;">${time}</span>
  </div>
  <div style="color:#fff;">${msg.text}</div>
`;

messageElement.style.borderLeft = `4px solid ${userColor}`;
messageElement.style.paddingLeft = "8px";
messageElement.style.marginBottom = "6px";



      messagesArea.appendChild(messageElement);
      messagesArea.scrollTo({ top: messagesArea.scrollHeight, behavior: 'smooth' });

      // 游댒 Notifica칞칚o apenas se for de outro usu치rio
      const isMyMessage = msg.username === usernameInput.value;

      if (!isMyMessage) {
        if (Notification.permission === "granted" && document.hidden) {
          new Notification(`Nova mensagem de ${msg.username}`, { body: msg.text });
          notificationSound.play().catch(() => {});
        }
      }

      // 游댳 Monitorar status do usu치rio
      const statusDiv = messageElement.querySelector(".status");
      monitorUserStatus(msg.username, statusDiv);

    });
    // Fun칞칚o para gerar cor consistente a partir do nome do usu치rio
function getUserColor(username) {
  let hash = 0;
  for (let i = 0; i < username.length; i++) {
    hash = username.charCodeAt(i) + ((hash << 5) - hash);
  }
  const color = `hsl(${hash % 360}, 70%, 60%)`; // HSL para cores vibrantes
  return color;
}


  }); // DOMContentLoaded
  
</script>

</body>
</html>
