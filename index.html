<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - NID</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="chat-container">
        <header>
            <h1>Chat</h1>
        </header>
        <div id="chat-messages" class="messages-area">
            <!-- As mensagens aparecerão aqui -->
        </div>
        <form id="chat-form" novalidate>
            <input type="text" id="username" placeholder="Seu nome">
            <div class="input-group">
                <input type="text" id="message-input" placeholder="Digite sua mensagem...">
                <button type="submit">Enviar</button>
            </div>
        </form>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // CONFIGURAÇÃO DO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBuiBi8B3Sf6hZfLOYd9Ezl6IXw8NbbF1A",
            authDomain: "mextill.firebaseapp.com",
            databaseURL: "https://mextill-default-rtdb.firebaseio.com",
            projectId: "mextill",
            storageBucket: "mextill.firebasestorage.app",
            messagingSenderId: "811140414542",
            appId: "1:811140414542:web:e695c35ec6d0cdf523571f",
            measurementId: "G-7D3J6PQVZM"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig );
        const db = getDatabase(app);
        const messagesRef = ref(db, 'messages');

        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const usernameInput = document.getElementById('username');
        const messagesArea = document.getElementById('chat-messages');

        // ENVIAR MENSAGEM
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const message = messageInput.value.trim();
            const username = usernameInput.value.trim();

            // Validação manual para evitar erros de "not focusable"
            if (!username) {
                alert("Por favor, digite seu nome.");
                usernameInput.focus();
                return;
            }
            if (!message) {
                messageInput.focus();
                return;
            }

            push(messagesRef, {
                username: username,
                text: message,
                timestamp: serverTimestamp()
            });
            
            messageInput.value = '';
            messageInput.focus();
        });

        // RECEBER MENSAGENS
        onChildAdded(messagesRef, (data) => {
            const msg = data.val();
            if (!msg) return;

            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            
            // Tratamento da hora
            let time = "";
            try {
                // Se o timestamp ainda não foi processado pelo servidor, usa a hora local
                const date = msg.timestamp ? new Date(msg.timestamp) : new Date();
                time = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                time = "--:--";
            }

            messageElement.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px;">
                    <span class="user" style="margin-bottom: 0; font-weight: bold; font-size: 0.8rem; color: #ff85c1;">${msg.username}:</span>
                    <span style="font-size: 0.7rem; color: #ff85c1; opacity: 0.7;">${time}</span>
                </div>
                <span class="text" style="color: #fff;">${msg.text}</span>
            `;
            
            messagesArea.appendChild(messageElement);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        });
    </script>
</body>
</html>
