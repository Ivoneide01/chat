<script type="module">

// ðŸ”” PermissÃ£o para notificaÃ§Ãµes
if (Notification.permission !== "granted") {
  Notification.requestPermission();
}

const notificationSound = new Audio('som.mp3');

// ðŸ”¥ IMPORTS FIREBASE
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";

import { 
  getDatabase, 
  ref, 
  push, 
  onChildAdded, 
  serverTimestamp,
  set,
  onDisconnect,
  onValue
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";


// ðŸ”¥ CONFIG FIREBASE
const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "mextill.firebaseapp.com",
  databaseURL: "https://mextill-default-rtdb.firebaseio.com",
  projectId: "mextill",
  storageBucket: "mextill.firebasestorage.app",
  messagingSenderId: "811140414542",
  appId: "1:811140414542:web:e695c35ec6d0cdf523571f"
};

// ðŸ”¥ INICIALIZAR
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const messagesRef = ref(db, 'messages');
const connectedRef = ref(db, ".info/connected");


// ðŸ”¹ ELEMENTOS DOM
const chatForm = document.getElementById('chat-form');
const messageInput = document.getElementById('message-input');
const usernameInput = document.getElementById('username');
const messagesArea = document.getElementById('chat-messages');


// =============================
// ðŸ”¥ ATIVAR STATUS ONLINE REAL
// =============================
function activateUserStatus(username) {

  const userStatusRef = ref(db, 'users/' + username);

  onValue(connectedRef, (snap) => {
    if (snap.val() === true) {

      // Marca online
      set(userStatusRef, {
        online: true,
        lastSeen: serverTimestamp()
      });

      // Quando desconectar
      onDisconnect(userStatusRef).update({
        online: false,
        lastSeen: serverTimestamp()
      });
    }
  });
}


// =============================
// ðŸ”¥ CARREGAR NOME SALVO
// =============================
const savedName = localStorage.getItem('chat_username');

if (savedName) {
  usernameInput.value = savedName;
  usernameInput.readOnly = true;
  usernameInput.style.opacity = "0.6";
  activateUserStatus(savedName);
}


// =============================
// ðŸ”¥ ENVIAR MENSAGEM
// =============================
chatForm.addEventListener('submit', (e) => {
  e.preventDefault();

  const message = messageInput.value.trim();
  const username = usernameInput.value.trim();

  if (!username) {
    alert("Por favor, digite seu nome.");
    return;
  }

  if (!message) return;

  // Salvar nome e ativar status
  if (!savedName) {
    localStorage.setItem('chat_username', username);
    usernameInput.readOnly = true;
    usernameInput.style.opacity = "0.6";
    activateUserStatus(username);
  }

  push(messagesRef, {
    username: username,
    text: message,
    timestamp: serverTimestamp()
  });

  messageInput.value = '';
});


// =============================
// ðŸ”¥ RECEBER MENSAGENS
// =============================
onChildAdded(messagesRef, (data) => {

  const msg = data.val();
  if (!msg) return;

  const messageElement = document.createElement('div');
  messageElement.classList.add('message');

  let time = "--:--";
  if (msg.timestamp) {
    const date = new Date(msg.timestamp);
    time = date.toLocaleTimeString('pt-BR', {
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  messageElement.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:baseline;">
      <div>
        <span class="user" style="font-weight:bold; color:#ff85c1;">
          ${msg.username}
        </span>
        <div class="status" style="font-size:0.65rem; opacity:0.7;"></div>
      </div>
      <span style="font-size:0.7rem; opacity:0.6;">${time}</span>
    </div>
    <div style="color:#fff;">${msg.text}</div>
  `;

  messagesArea.appendChild(messageElement);
  messagesArea.scrollTop = messagesArea.scrollHeight;

  // ðŸ”” NotificaÃ§Ã£o
  const isMyMessage = msg.username === usernameInput.value;

  if (!isMyMessage) {
    notificationSound.play().catch(() => {});
  }

  if (Notification.permission === "granted" && document.hidden && !isMyMessage) {
    new Notification(`Nova mensagem de ${msg.username}`, {
      body: msg.text
    });
  }

  // =============================
  // ðŸ”¥ STATUS ONLINE / VISTO
  // =============================
  const statusRef = ref(db, 'users/' + msg.username);

  onValue(statusRef, (snapshot) => {
    const userData = snapshot.val();
    const statusDiv = messageElement.querySelector(".status");

    if (!userData) return;

    if (userData.online) {
      statusDiv.innerHTML = "ðŸŸ¢ Online";
    } else if (userData.lastSeen) {
      const date = new Date(userData.lastSeen);
      statusDiv.innerHTML = "Visto Ã s " + date.toLocaleTimeString('pt-BR', {
        hour: '2-digit',
        minute: '2-digit'
      });
    }
  });

});

</script>
