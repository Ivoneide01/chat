<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="chat-container">
<header>
<h1>Chat</h1>
</header>

<div id="chat-messages" class="messages-area"></div>

<form id="chat-form" novalidate>
<input type="text" id="username" placeholder="Seu nome">
<div class="input-group">
<input type="text" id="message-input" placeholder="Digite sua mensagem...">
<button type="button" id="record-btn">ðŸŽ¤</button>
<button type="submit">Enviar</button>
</div>
</form>
</div>

<script type="module">

// ðŸ”” NotificaÃ§Ã£o
if (Notification.permission !== "granted") {
  Notification.requestPermission();
}

const notificationSound = new Audio('som.mp3');

// ðŸ”¥ IMPORTS
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, serverTimestamp, onDisconnect, onValue, update }
from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL }
from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

// ðŸ”¥ CONFIG
const firebaseConfig = {
  apiKey: "SUA_API_KEY_AQUI",
  authDomain: "mextill.firebaseapp.com",
  databaseURL: "https://mextill-default-rtdb.firebaseio.com",
  projectId: "mextill",
  storageBucket: "mextill.firebasestorage.app",
  messagingSenderId: "811140414542",
  appId: "1:811140414542:web:e695c35ec6d0cdf523571f"
};

// ðŸ”¥ INIT
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

const messagesRef = ref(db, 'messages');
const connectedRef = ref(db, ".info/connected");

// DOM
const chatForm = document.getElementById('chat-form');
const messageInput = document.getElementById('message-input');
const usernameInput = document.getElementById('username');
const messagesArea = document.getElementById('chat-messages');
const recordBtn = document.getElementById('record-btn');

let typingTimeout;

// ================= ONLINE =================
function activateUserStatus(username) {
  const userStatusRef = ref(db, 'users/' + username);

  onValue(connectedRef, (snap) => {
    if (snap.val() === true) {
      update(userStatusRef, {
        online: true,
        lastSeen: serverTimestamp(),
        typing: false
      });

      onDisconnect(userStatusRef).update({
        online: false,
        lastSeen: serverTimestamp(),
        typing: false
      });
    }
  });
}

// ================= NOME SALVO =================
const savedName = localStorage.getItem('chat_username');

if (savedName) {
  usernameInput.value = savedName;
  usernameInput.readOnly = true;
  usernameInput.style.opacity = "0.6";
  activateUserStatus(savedName);
}

// ================= DIGITAÃ‡ÃƒO =================
messageInput.addEventListener("input", () => {
  const username = usernameInput.value.trim();
  if (!username) return;

  const userRef = ref(db, 'users/' + username);

  update(userRef, { typing: true, online: true });

  clearTimeout(typingTimeout);

  typingTimeout = setTimeout(() => {
    update(userRef, { typing: false });
  }, 1500);
});

// ================= ENVIAR TEXTO =================
chatForm.addEventListener('submit', (e) => {
  e.preventDefault();

  const message = messageInput.value.trim();
  const username = usernameInput.value.trim();

  if (!username) {
    alert("Digite seu nome.");
    return;
  }

  if (!message) return;

  if (!savedName) {
    localStorage.setItem('chat_username', username);
    usernameInput.readOnly = true;
    usernameInput.style.opacity = "0.6";
    activateUserStatus(username);
  }

  push(messagesRef, {
    username,
    text: message,
    type: "text",
    timestamp: serverTimestamp()
  });

  update(ref(db, 'users/' + username), { typing: false });

  messageInput.value = '';
});

// ================= RECEBER =================
onChildAdded(messagesRef, (data) => {

  const msg = data.val();
  if (!msg) return;

  const messageElement = document.createElement('div');
  messageElement.classList.add('message');

  let time = "--:--";
  if (msg.timestamp) {
    const date = new Date(msg.timestamp);
    time = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
  }

  let contentHTML = msg.type === "audio"
    ? `<audio controls src="${msg.audioUrl}"></audio>`
    : msg.text;

  messageElement.innerHTML = `
    <div style="display:flex; justify-content:space-between;">
      <div>
        <span style="font-weight:bold; color:#ff85c1;">
          ${msg.username}
        </span>
      </div>
      <span style="font-size:0.7rem; opacity:0.6;">${time}</span>
    </div>
    <div style="color:#fff;">${contentHTML}</div>
  `;

  messagesArea.appendChild(messageElement);
  messagesArea.scrollTop = messagesArea.scrollHeight;
});

// ================= ðŸŽ¤ ÃUDIO ESTÃVEL =================
let mediaRecorder;
let audioChunks = [];
let stream;

recordBtn.addEventListener("click", async () => {

  const username = usernameInput.value.trim();
  if (!username) {
    alert("Digite seu nome primeiro.");
    return;
  }

  // Se jÃ¡ estiver gravando â†’ parar
  if (mediaRecorder && mediaRecorder.state === "recording") {
    mediaRecorder.stop();
    recordBtn.innerHTML = "ðŸŽ¤";
    return;
  }

  try {
    stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    mediaRecorder.ondataavailable = e => {
      if (e.data.size > 0) {
        audioChunks.push(e.data);
      }
    };

    mediaRecorder.onstop = async () => {

      try {

        const blob = new Blob(audioChunks, { type: "audio/webm" });

        if (blob.size < 1000) {
          console.log("Ãudio muito curto.");
          return;
        }

        const audioFileRef = storageRef(
          storage,
          `audios/${username}_${Date.now()}.webm`
        );

        await uploadBytes(audioFileRef, blob);
        const downloadURL = await getDownloadURL(audioFileRef);

        push(messagesRef, {
          username,
          audioUrl: downloadURL,
          type: "audio",
          timestamp: serverTimestamp()
        });

      } catch (error) {
        console.error("Erro upload:", error);
        alert("Erro ao enviar Ã¡udio. Veja o console.");
      }

      stream.getTracks().forEach(track => track.stop());
    };

    mediaRecorder.start();
    recordBtn.innerHTML = "ðŸ”´ Parar";

  } catch (err) {
    console.error("Erro microfone:", err);
    alert("PermissÃ£o de microfone negada.");
  }

});

</script>
</body>
</html>
