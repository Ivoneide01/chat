<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<button id="login-btn">Entrar com Google</button>
<button id="logout-btn" style="display:none;">Sair</button>

<div class="chat-container">
<header>
<h1>Chat</h1>
</header>

<div id="chat-messages" class="messages-area"></div>

<form id="chat-form">
<div class="input-group">
<input type="text" id="message-input" placeholder="Digite sua mensagem...">
<button type="button" id="record-btn">ðŸŽ¤</button>
<button type="submit">Enviar</button>
</div>
</form>
</div>

<script type="module">

// ðŸ”¥ IMPORTS
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, serverTimestamp }
from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

import {
  getAuth,
  signInWithPopup,
  GoogleAuthProvider,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

import {
  getStorage,
  ref as storageRef,
  uploadBytes,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

// ðŸ”¥ CONFIG
const firebaseConfig = {
  apiKey: "SUA_API_KEY_AQUI",
  authDomain: "mextill.firebaseapp.com",
  databaseURL: "https://mextill-default-rtdb.firebaseio.com",
  projectId: "mextill",
  storageBucket: "mextill.firebasestorage.app",
  messagingSenderId: "811140414542",
  appId: "1:811140414542:web:e695c35ec6d0cdf523571f"
};

// ðŸ”¥ INIT
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const storage = getStorage(app);
const provider = new GoogleAuthProvider();

const messagesRef = ref(db, "messages");

// DOM
const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout-btn");
const chatForm = document.getElementById("chat-form");
const messageInput = document.getElementById("message-input");
const messagesArea = document.getElementById("chat-messages");
const recordBtn = document.getElementById("record-btn");

let currentUser = null;

// ================= LOGIN =================
loginBtn.onclick = async () => {
  await signInWithPopup(auth, provider);
};

logoutBtn.onclick = async () => {
  await signOut(auth);
};

onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUser = user;
    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";
  } else {
    currentUser = null;
    loginBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
  }
});

// ================= ENVIAR TEXTO =================
chatForm.addEventListener("submit", (e) => {
  e.preventDefault();

  if (!currentUser) {
    alert("FaÃ§a login primeiro.");
    return;
  }

  const message = messageInput.value.trim();
  if (!message) return;

  push(messagesRef, {
    uid: currentUser.uid,
    name: currentUser.displayName,
    photo: currentUser.photoURL,
    text: message,
    type: "text",
    timestamp: serverTimestamp()
  });

  messageInput.value = "";
});

// ================= RECEBER =================
onChildAdded(messagesRef, (snapshot) => {

  const msg = snapshot.val();
  if (!msg) return;

  const messageElement = document.createElement("div");
  messageElement.classList.add("message");

  let content = msg.type === "audio"
    ? `<audio controls src="${msg.audioUrl}"></audio>`
    : msg.text;

  messageElement.innerHTML = `
    <div style="display:flex;align-items:center;gap:8px;">
      <img src="${msg.photo}" width="30" style="border-radius:50%">
      <strong>${msg.name}</strong>
    </div>
    <div>${content}</div>
  `;

  messagesArea.appendChild(messageElement);
  messagesArea.scrollTop = messagesArea.scrollHeight;
});

// ================= ðŸŽ¤ ÃUDIO =================
let mediaRecorder;
let audioChunks = [];
let stream;

recordBtn.addEventListener("click", async () => {

  if (!currentUser) {
    alert("FaÃ§a login primeiro.");
    return;
  }

  if (mediaRecorder && mediaRecorder.state === "recording") {
    mediaRecorder.stop();
    recordBtn.innerHTML = "ðŸŽ¤";
    return;
  }

  try {
    stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    mediaRecorder.ondataavailable = e => {
      if (e.data.size > 0) audioChunks.push(e.data);
    };

    mediaRecorder.onstop = async () => {

      try {

        const blob = new Blob(audioChunks, { type: "audio/webm" });

        if (blob.size < 1000) return;

        const audioRef = storageRef(
          storage,
          `audios/${currentUser.uid}_${Date.now()}.webm`
        );

        await uploadBytes(audioRef, blob);
        const url = await getDownloadURL(audioRef);

        push(messagesRef, {
          uid: currentUser.uid,
          name: currentUser.displayName,
          photo: currentUser.photoURL,
          audioUrl: url,
          type: "audio",
          timestamp: serverTimestamp()
        });

      } catch (error) {
        console.error("Erro upload:", error);
      }

      stream.getTracks().forEach(track => track.stop());
    };

    mediaRecorder.start();
    recordBtn.innerHTML = "ðŸ”´ Parar";

  } catch (err) {
    console.error("Erro microfone:", err);
  }

});

</script>
</body>
</html>
