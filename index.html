<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="chat-container">
        <header>
            <h1>Chat</h1>
        </header>
        <div id="chat-messages" class="messages-area">
            <!-- As mensagens aparecer√£o aqui -->
        </div>
        <form id="chat-form" novalidate>
            <input type="text" id="username" placeholder="Seu nome">
            <div class="input-group">
                <input type="text" id="message-input" placeholder="Digite sua mensagem...">
                <button type="submit">Enviar</button>
            </div>
        </form>
    </div>

<script type="module">

// üîî Permiss√£o notifica√ß√£o
if (Notification.permission !== "granted") {
  Notification.requestPermission();
}

const notificationSound = new Audio('som.mp3');

// üî• IMPORTS
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";

import { 
  getDatabase, 
  ref, 
  push, 
  onChildAdded, 
  serverTimestamp,
  onDisconnect,
  onValue,
  update
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";


// üî• CONFIG FIREBASE (MANTENHA SUA CONFIG ORIGINAL)
const firebaseConfig = {
  apiKey: "SUA_API_KEY_AQUI",
  authDomain: "mextill.firebaseapp.com",
  databaseURL: "https://mextill-default-rtdb.firebaseio.com",
  projectId: "mextill",
  storageBucket: "mextill.firebasestorage.app",
  messagingSenderId: "811140414542",
  appId: "1:811140414542:web:e695c35ec6d0cdf523571f"
};


// üî• INICIALIZA√á√ÉO
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const messagesRef = ref(db, 'messages');
const connectedRef = ref(db, ".info/connected");

// üîπ DOM
const chatForm = document.getElementById('chat-form');
const messageInput = document.getElementById('message-input');
const usernameInput = document.getElementById('username');
const messagesArea = document.getElementById('chat-messages');

let typingTimeout;


// ========================================
// üî• ATIVAR STATUS ONLINE REAL
// ========================================
function activateUserStatus(username) {

  const userStatusRef = ref(db, 'users/' + username);

  onValue(connectedRef, (snap) => {
    if (snap.val() === true) {

      update(userStatusRef, {
        online: true,
        lastSeen: serverTimestamp(),
        typing: false
      });

      onDisconnect(userStatusRef).update({
        online: false,
        lastSeen: serverTimestamp(),
        typing: false
      });
    }
  });
}


// ========================================
// üî• CARREGAR NOME SALVO
// ========================================
const savedName = localStorage.getItem('chat_username');

if (savedName) {
  usernameInput.value = savedName;
  usernameInput.readOnly = true;
  usernameInput.style.opacity = "0.6";
  activateUserStatus(savedName);
}


// ========================================
// üî• DETECTAR DIGITA√á√ÉO
// ========================================
messageInput.addEventListener("input", () => {

  const username = usernameInput.value.trim();
  if (!username) return;

  const userRef = ref(db, 'users/' + username);

  // Marca digitando
  update(userRef, {
    typing: true,
    online: true
  });

  clearTimeout(typingTimeout);

  typingTimeout = setTimeout(() => {
    update(userRef, {
      typing: false
    });
  }, 1500);
});


// ========================================
// üî• ENVIAR MENSAGEM
// ========================================
chatForm.addEventListener('submit', (e) => {
  e.preventDefault();

  const message = messageInput.value.trim();
  const username = usernameInput.value.trim();

  if (!username) {
    alert("Digite seu nome.");
    return;
  }

  if (!message) return;

  if (!savedName) {
    localStorage.setItem('chat_username', username);
    usernameInput.readOnly = true;
    usernameInput.style.opacity = "0.6";
    activateUserStatus(username);
  }

  push(messagesRef, {
    username: username,
    text: message,
    timestamp: serverTimestamp()
  });

  // Parar digitando ao enviar
  update(ref(db, 'users/' + username), {
    typing: false
  });

  messageInput.value = '';
});


// ========================================
// üî• RECEBER MENSAGENS
// ========================================
onChildAdded(messagesRef, (data) => {

  const msg = data.val();
  if (!msg) return;

  const messageElement = document.createElement('div');
  messageElement.classList.add('message');

  let time = "--:--";
  if (msg.timestamp) {
    const date = new Date(msg.timestamp);
    time = date.toLocaleTimeString('pt-BR', {
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  messageElement.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:baseline;">
      <div>
        <span class="user" style="font-weight:bold; color:#ff85c1;">
          ${msg.username}
        </span>
        <div class="status" style="font-size:0.65rem; opacity:0.7;"></div>
      </div>
      <span style="font-size:0.7rem; opacity:0.6;">${time}</span>
    </div>
    <div style="color:#fff;">${msg.text}</div>
  `;

  messagesArea.appendChild(messageElement);
  messagesArea.scrollTop = messagesArea.scrollHeight;

  const isMyMessage = msg.username === usernameInput.value;

  if (!isMyMessage) {
    notificationSound.play().catch(() => {});
  }

  if (Notification.permission === "granted" && document.hidden && !isMyMessage) {
    new Notification(`Nova mensagem de ${msg.username}`, {
      body: msg.text
    });
  }

  // ========================================
  // üî• STATUS + DIGITANDO
  // ========================================
  const statusRef = ref(db, 'users/' + msg.username);

  onValue(statusRef, (snapshot) => {

    const userData = snapshot.val();
    const statusDiv = messageElement.querySelector(".status");

    if (!userData) return;

    if (userData.typing && !isMyMessage) {
      statusDiv.innerHTML = "‚úçÔ∏è Digitando...";
    }
    else if (userData.online) {
      statusDiv.innerHTML = "üü¢ Online";
    }
    else if (userData.lastSeen) {
      const date = new Date(userData.lastSeen);
      statusDiv.innerHTML = "Visto √†s " + date.toLocaleTimeString('pt-BR', {
        hour: '2-digit',
        minute: '2-digit'
      });
    }

  });

});

</script>


</body>
</html>
