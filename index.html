<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat Firebase</title>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #0f0f0f;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}

.chat-container {
  width: 400px;
  height: 650px;
  background: #111;
  border-radius: 16px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  border: 2px solid #14b8a6;
}

header {
  background: #14b8a6;
  color: black;
  padding: 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

header h1 {
  margin: 0;
  font-size: 20px;
}

header div {
  display: flex;
  gap: 8px;
}

button {
  background: #14b8a6;
  border: none;
  padding: 6px 10px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
}

.messages-area {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
}

.message {
  background: #2a2a2a;
  padding: 10px;
  border-radius: 12px;
  margin-bottom: 10px;
  color: white;
}

.message-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 5px;
}

.message img {
  width: 30px;
  height: 30px;
  border-radius: 50%;
}

form {
  padding: 10px;
  background: #1a1a1a;
}

.input-group {
  display: flex;
  gap: 5px;
}

input {
  flex: 1;
  padding: 8px;
  border-radius: 8px;
  border: none;
  outline: none;
}

audio {
  width: 100%;
  margin-top: 5px;
}
</style>
</head>
<body>

<div class="chat-container">

  <header>
    <h1>Chat</h1>
    <div>
      <button id="login-btn">Entrar</button>
      <button id="logout-btn" style="display:none;">Sair</button>
    </div>
  </header>

  <div id="chat-messages" class="messages-area"></div>

  <form id="chat-form">
    <div class="input-group">
      <input type="text" id="message-input" placeholder="Digite sua mensagem...">
      <button type="button" id="record-btn">ðŸŽ¤</button>
      <button type="submit">Enviar</button>
    </div>
  </form>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, serverTimestamp }
from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

import {
  getAuth,
  signInWithPopup,
  GoogleAuthProvider,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

import {
  getStorage,
  ref as storageRef,
  uploadBytes,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "SUA_API_KEY_AQUI",
  authDomain: "mextill.firebaseapp.com",
  databaseURL: "https://mextill-default-rtdb.firebaseio.com",
  projectId: "mextill",
  storageBucket: "mextill.firebasestorage.app",
  messagingSenderId: "811140414542",
  appId: "1:811140414542:web:e695c35ec6d0cdf523571f"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const storage = getStorage(app);
const provider = new GoogleAuthProvider();

const messagesRef = ref(db, "messages");

const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout-btn");
const chatForm = document.getElementById("chat-form");
const messageInput = document.getElementById("message-input");
const messagesArea = document.getElementById("chat-messages");
const recordBtn = document.getElementById("record-btn");

let currentUser = null;

loginBtn.onclick = async () => {
  await signInWithPopup(auth, provider);
};

logoutBtn.onclick = async () => {
  await signOut(auth);
};

onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUser = user;
    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";
  } else {
    currentUser = null;
    loginBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
  }
});

chatForm.addEventListener("submit", (e) => {
  e.preventDefault();

  if (!currentUser) {
    alert("FaÃ§a login primeiro.");
    return;
  }

  const message = messageInput.value.trim();
  if (!message) return;

  push(messagesRef, {
    uid: currentUser.uid,
    name: currentUser.displayName || "UsuÃ¡rio",
    photo: currentUser.photoURL || "",
    text: message,
    type: "text",
    timestamp: serverTimestamp()
  });

  messageInput.value = "";
});

onChildAdded(messagesRef, (snapshot) => {
  const msg = snapshot.val();
  if (!msg) return;

  const messageElement = document.createElement("div");
  messageElement.classList.add("message");

  let content = msg.type === "audio"
    ? `<audio controls src="${msg.audioUrl}"></audio>`
    : msg.text;

  messageElement.innerHTML = `
    <div class="message-header">
      <img src="${msg.photo || "https://via.placeholder.com/30"}">
      <strong>${msg.name || "UsuÃ¡rio"}</strong>
    </div>
    <div>${content}</div>
  `;

  messagesArea.appendChild(messageElement);
  messagesArea.scrollTop = messagesArea.scrollHeight;
});

let mediaRecorder;
let audioChunks = [];
let stream;

recordBtn.addEventListener("click", async () => {

  if (!currentUser) {
    alert("FaÃ§a login primeiro.");
    return;
  }

  if (mediaRecorder && mediaRecorder.state === "recording") {
    mediaRecorder.stop();
    recordBtn.innerHTML = "ðŸŽ¤";
    return;
  }

  stream = await navigator.mediaDevices.getUserMedia({ audio: true });

  mediaRecorder = new MediaRecorder(stream);
  audioChunks = [];

  mediaRecorder.ondataavailable = e => {
    if (e.data.size > 0) audioChunks.push(e.data);
  };

  mediaRecorder.onstop = async () => {

    const blob = new Blob(audioChunks, { type: "audio/webm" });

    if (blob.size < 1000) return;

    const audioRef = storageRef(
      storage,
      `audios/${currentUser.uid}_${Date.now()}.webm`
    );

    await uploadBytes(audioRef, blob);
    const url = await getDownloadURL(audioRef);

    push(messagesRef, {
      uid: currentUser.uid,
      name: currentUser.displayName || "UsuÃ¡rio",
      photo: currentUser.photoURL || "",
      audioUrl: url,
      type: "audio",
      timestamp: serverTimestamp()
    });

    stream.getTracks().forEach(track => track.stop());
  };

  mediaRecorder.start();
  recordBtn.innerHTML = "ðŸ”´";

});

</script>
</body>
</html>
