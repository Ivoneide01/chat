<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="chat-container">
        <header>
            <h1>Chat em construção</h1>
            <span id="display-username" style="font-size: 0.8rem; opacity: 0.8;"></span>
        </header>
        <div id="chat-messages" class="messages-area">
            <!-- Mensagens aparecerão aqui -->
        </div>
        <form id="chat-form">
            <div id="username-container">
                <input type="text" id="username" placeholder="definir nome" required>
            </div>
            <div class="input-group">
                <input type="text" id="message-input" placeholder="Digite sua mensagem..." required>
                <button type="submit">Enviar</button>
            </div>
        </form>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBuiBi8B3Sf6hZfLOYd9Ezl6IXw8NbbF1A",
            authDomain: "mextill.firebaseapp.com",
            databaseURL: "https://mextill-default-rtdb.firebaseio.com",
            projectId: "mextill",
            storageBucket: "mextill.firebasestorage.app",
            messagingSenderId: "811140414542",
            appId: "1:811140414542:web:e695c35ec6d0cdf523571f",
            measurementId: "G-7D3J6PQVZM"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const messagesRef = ref(db, 'messages');

        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const usernameInput = document.getElementById('username');
        const usernameContainer = document.getElementById('username-container');
        const displayUsername = document.getElementById('display-username');
        const messagesArea = document.getElementById('chat-messages');

        // Verificar se já existe um nome salvo
        let savedUsername = localStorage.getItem('chat_username');
        
        if (savedUsername) {
            usernameContainer.style.display = 'none';
            displayUsername.innerText = `Logado como: ${savedUsername}`;
        }

        // Enviar mensagem
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            let username = savedUsername;
            
            // Se não tiver nome salvo, pega do input e salva
            if (!username) {
                username = usernameInput.value.trim();
                if (username) {
                    localStorage.setItem('chat_username', username);
                    savedUsername = username;
                    usernameContainer.style.display = 'none';
                    displayUsername.innerText = `Logado como: ${username}`;
                }
            }

            const message = messageInput.value;

            if (message.trim() && username) {
                push(messagesRef, {
                    username: username,
                    text: message,
                    timestamp: serverTimestamp()
                });
                messageInput.value = '';
            }
        });

        // Receber mensagens
        onChildAdded(messagesRef, (data) => {
            const msg = data.val();
            if (!msg) return; // Segurança: ignora se a mensagem estiver vazia

            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            
            // Tratamento seguro do timestamp
            let time = "";
            try {
                // Se o timestamp ainda não chegou do servidor, usa a hora atual do PC
                const date = msg.timestamp ? new Date(msg.timestamp) : new Date();
                time = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                time = "--:--";
            }

            messageElement.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px;">
                    <span class="user" style="margin-bottom: 0;">${msg.username}:</span>
                    <span style="font-size: 0.7rem; color: #ff85c1; opacity: 0.7;">${time}</span>
                </div>
                <span class="text">${msg.text}</span>
            `;
            
            messagesArea.appendChild(messageElement);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        });
    </script>

</body>
</html>