<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="chat-container">
        <header>
            <h1>Chat</h1>
        </header>
        <div id="chat-messages" class="messages-area">
            <!-- As mensagens aparecerÃ£o aqui -->
        </div>
        <form id="chat-form" novalidate>
            <input type="text" id="username" placeholder="Seu nome">
            <div class="input-group">
                <input type="text" id="message-input" placeholder="Digite sua mensagem...">
                <button type="button" id="record-btn">ðŸŽ¤</button>
                <button type="submit">Enviar</button>
            </div>
        </form>
    </div>

<script type="module">

// ðŸ”” PermissÃ£o notificaÃ§Ã£o
if (Notification.permission !== "granted") {
  Notification.requestPermission();
}

const notificationSound = new Audio('som.mp3');

// ðŸ”¥ IMPORTS
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";

import { 
  getDatabase, 
  ref, 
  push, 
  onChildAdded, 
  serverTimestamp,
  onDisconnect,
  onValue,
  update
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
import { 
  getAuth, 
  signInWithPopup, 
  GoogleAuthProvider,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";


import { 
  getStorage, 
  ref as storageRef, 
  uploadBytes, 
  getDownloadURL 
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";


// ðŸ”¥ CONFIG FIREBASE
const firebaseConfig = {
  apiKey: "SUA_API_KEY_AQUI",
  authDomain: "mextill.firebaseapp.com",
  databaseURL: "https://mextill-default-rtdb.firebaseio.com",
  projectId: "mextill",
  storageBucket: "mextill.firebasestorage.app",
  messagingSenderId: "811140414542",
  appId: "1:811140414542:web:e695c35ec6d0cdf523571f"
};



// ðŸ”¥ INICIALIZAÃ‡ÃƒO
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

const messagesRef = ref(db, 'messages');
const connectedRef = ref(db, ".info/connected");

// ðŸ”¹ DOM
const chatForm = document.getElementById('chat-form');
const messageInput = document.getElementById('message-input');
const usernameInput = document.getElementById('username');
const messagesArea = document.getElementById('chat-messages');
const recordBtn = document.getElementById('record-btn');

let typingTimeout;


// ========================================
// ðŸ”¥ ATIVAR STATUS ONLINE REAL
// ========================================
function activateUserStatus(username) {

  const userStatusRef = ref(db, 'users/' + username);

  onValue(connectedRef, (snap) => {
    if (snap.val() === true) {

      update(userStatusRef, {
        online: true,
        lastSeen: serverTimestamp(),
        typing: false
      });

      onDisconnect(userStatusRef).update({
        online: false,
        lastSeen: serverTimestamp(),
        typing: false
      });
    }
  });
}


// ========================================
// ðŸ”¥ CARREGAR NOME SALVO
// ========================================
const savedName = localStorage.getItem('chat_username');

if (savedName) {
  usernameInput.value = savedName;
  usernameInput.readOnly = true;
  usernameInput.style.opacity = "0.6";
  activateUserStatus(savedName);
}


// ========================================
// ðŸ”¥ DIGITAÃ‡ÃƒO
// ========================================
messageInput.addEventListener("input", () => {

  const username = usernameInput.value.trim();
  if (!username) return;

  const userRef = ref(db, 'users/' + username);

  update(userRef, {
    typing: true,
    online: true
  });

  clearTimeout(typingTimeout);

  typingTimeout = setTimeout(() => {
    update(userRef, { typing: false });
  }, 1500);
});


// ========================================
// ðŸ”¥ ENVIAR TEXTO
// ========================================
chatForm.addEventListener('submit', (e) => {
  e.preventDefault();

  const message = messageInput.value.trim();
  const username = usernameInput.value.trim();

  if (!username) {
    alert("Digite seu nome.");
    return;
  }

  if (!message) return;

  if (!savedName) {
    localStorage.setItem('chat_username', username);
    usernameInput.readOnly = true;
    usernameInput.style.opacity = "0.6";
    activateUserStatus(username);
  }

  push(messagesRef, {
    username: username,
    text: message,
    type: "text",
    timestamp: serverTimestamp()
  });

  update(ref(db, 'users/' + username), { typing: false });

  messageInput.value = '';
});


// ========================================
// ðŸ”¥ RECEBER MENSAGENS (SUPORTE ÃUDIO)
// ========================================
onChildAdded(messagesRef, (data) => {

  const msg = data.val();
  if (!msg) return;

  const messageElement = document.createElement('div');
  messageElement.classList.add('message');

  let time = "--:--";
  if (msg.timestamp) {
    const date = new Date(msg.timestamp);
    time = date.toLocaleTimeString('pt-BR', {
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  let contentHTML = "";

  if (msg.type === "audio") {
    contentHTML = `<audio controls src="${msg.audioUrl}"></audio>`;
  } else {
    contentHTML = msg.text;
  }

  messageElement.innerHTML = `
    <div style="display:flex; justify-content:space-between;">
      <div>
        <span style="font-weight:bold; color:#ff85c1;">
          ${msg.username}
        </span>
        <div class="status" style="font-size:0.65rem; opacity:0.7;"></div>
      </div>
      <span style="font-size:0.7rem; opacity:0.6;">${time}</span>
    </div>
    <div style="color:#fff;">${contentHTML}</div>
  `;

  messagesArea.appendChild(messageElement);
  messagesArea.scrollTop = messagesArea.scrollHeight;
});


// ========================================
// ðŸŽ¤ GRAVAÃ‡ÃƒO ESTILO WHATSAPP
// ========================================
let mediaRecorder;
let audioChunks = [];
let recordingStart;
let stream;

async function startRecording() {

  const username = usernameInput.value.trim();
  if (!username) {
    alert("Digite seu nome primeiro.");
    return;
  }

  try {
    stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    recordingStart = Date.now();

    mediaRecorder.ondataavailable = e => {
      audioChunks.push(e.data);
    };

    mediaRecorder.start();
    recordBtn.innerHTML = "ðŸ”´ Gravando...";
  } catch (err) {
    alert("PermissÃ£o de microfone negada.");
  }
}

async function stopRecording() {

  if (!mediaRecorder) return;

  mediaRecorder.stop();

  mediaRecorder.onstop = async () => {

    const duration = (Date.now() - recordingStart) / 1000;

    if (duration < 1) {
      recordBtn.innerHTML = "ðŸŽ¤";
      stream.getTracks().forEach(track => track.stop());
      return;
    }

    const audioBlob = new Blob(audioChunks, { type: "audio/webm" });

    const username = usernameInput.value.trim();

    const audioFileRef = storageRef(
      storage,
      `audios/${username}_${Date.now()}.webm`
    );

    await uploadBytes(audioFileRef, audioBlob);
    const downloadURL = await getDownloadURL(audioFileRef);

    push(messagesRef, {
      username,
      audioUrl: downloadURL,
      type: "audio",
      timestamp: serverTimestamp()
    });

    recordBtn.innerHTML = "ðŸŽ¤";
    stream.getTracks().forEach(track => track.stop());
  };
}

// Desktop
recordBtn.addEventListener("mousedown", startRecording);
recordBtn.addEventListener("mouseup", stopRecording);
recordBtn.addEventListener("mouseleave", stopRecording);

// Mobile
recordBtn.addEventListener("touchstart", startRecording);
recordBtn.addEventListener("touchend", stopRecording);

</script>



</body>
</html>
