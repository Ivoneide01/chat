<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>
<link rel="stylesheet" href="style.css">
<style>
  body {
    background-color: #000;
    color: #030a0b;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
  }
  

  .chat-container {
    width: 90%;
    max-width: 500px;
    height: 80vh;
    background-color: #1a1a1a;
    border: 2px solid #00baaebd;
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 0 20px rgba(255, 105, 180, 0.3);
  }

  header {
    background-color: #00baaebd;
    color: #000;
    padding: 15px;
    text-align: center;
  }

  header h1 {
    margin: 0;
    font-size: 1.5rem;
  }

  .messages-area {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
    background: #222;
  }

  .message {
    display: flex;
    margin-bottom: 6px;
    align-items: flex-start;
  }

  .message img {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    margin-right: 8px;
  }

  .message-content {
    flex: 1;
    border-radius: 5px;
    padding: 6px 10px;
    background: #333;
  }

  .message .user {
    font-weight: bold;
  }

 #typing-indicator {
  font-style: italic;
  margin: 4px 10px;
  color: #00ffcc;
  animation: blinkTyping 1.5s infinite;
}

@keyframes blinkTyping {
  0% { opacity: 0.4; }
  50% { opacity: 1; }
  100% { opacity: 0.4; }
}

  .input-group {
    display: flex;
    gap: 10px;
  }

  #message-input {
    flex: 1;
    background-color: #222;
    border: 1px solid #00baaebd;
    color: #fff;
    padding: 10px;
    border-radius: 5px;
  }

  button {
    background-color: #00baaebd;
    color: #000;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s;
  }

  button:hover {
    background-color: #047641c9;
  }

  .dancing {
    font-size: 3rem;
    display: inline-block;
    animation: dance 1s infinite;
    color: #ff69b4;
    text-shadow: 2px 2px 5px #000;
  }

@keyframes dance {
  0%   { transform: translateY(0px) rotate(0deg); }
  50%  { transform: translateY(8px) rotate(-5deg); }
  100% { transform: translateY(0px) rotate(0deg); }
}

</style>
</head>
<body>
<div class="chat-container">
  <header>
  <h1 id="chat-title" class="dancing">Chat</h1>
</header>

  <div id="chat-messages" class="messages-area"></div>
  <div id="typing-indicator"></div>

  <form id="chat-form" novalidate>
    <input type="text" id="username" placeholder="Seu nome">
    <div class="input-group">
      <input type="text" id="message-input" placeholder="Digite sua mensagem...">
      <button type="submit">Enviar</button><button type="button" id="nudge-btn">âš¡</button>
      <button type="button" id="record-btn">ðŸŽ¤ Gravar</button>

      <!-- Input escondido para imagens -->
      <input type="file" id="image-input" accept="image/*" style="display:none;">
      <!-- BotÃ£o customizado para enviar imagem -->
      <button type="button" id="image-btn">ðŸ“Ž Enviar Imagem</button>
    </div>
  </form>
</div>

<!-- Modal de visualizaÃ§Ã£o -->
<div id="preview-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:9999;">
  <span id="close-preview" style="position:absolute; top:20px; right:30px; font-size:2rem; color:#fff; cursor:pointer;">&times;</span>
  <img id="preview-image" style="max-width:90%; max-height:80%; display:none; border-radius:10px;">
  <video id="preview-video" controls style="max-width:90%; max-height:80%; display:none; border-radius:10px;"></video>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";
import { getDatabase, ref, push, onChildAdded, serverTimestamp, set, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

document.addEventListener('DOMContentLoaded', () => {

  // ðŸ”” Sons
  const notificationSound = new Audio('som.mp3');
  const typingSound = new Audio('typing.mp3');
  typingSound.volume = 0.3;

  // ðŸ”” PermissÃ£o de notificaÃ§Ã£o
  if ("Notification" in window && Notification.permission !== "granted") {
    Notification.requestPermission();
  }

  // ðŸ”¥ Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBuiBi8B3Sf6hZfLOYd9Ezl6IXw8NbbF1A",
    authDomain: "mextill.firebaseapp.com",
    databaseURL: "https://mextill-default-rtdb.firebaseio.com",
    projectId: "mextill",
    storageBucket: "mextill.firebasestorage.app",
    messagingSenderId: "811140414542",
    appId: "1:811140414542:web:e695c35ec6d0cdf523571f",
    measurementId: "G-7D3J6PQVZM"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const storage = getStorage(app);

  const messagesRef = ref(db, 'messages');
  const typingRef = ref(db, 'typing');
  const presenceRef = ref(db, 'presence');

  // ðŸŽ¯ Elementos
  const chatForm = document.getElementById('chat-form');
  const messageInput = document.getElementById('message-input');
  const usernameInput = document.getElementById('username');
  const messagesArea = document.getElementById('chat-messages');
  const typingIndicator = document.getElementById('typing-indicator');
  const imageInput = document.getElementById('image-input');
  const imageBtn = document.getElementById('image-btn');
  const recordBtn = document.getElementById('record-btn');
  const chatTitle = document.getElementById("chat-title");

  // ðŸ‘® UsuÃ¡rios permitidos
  const usuariosPermitidos = ["disteseach", "distraction", "nid"];
  function podeVerTudo(username) {
    return usuariosPermitidos.includes(
      username.trim().toLowerCase()
    );
  }

  // ðŸŽ¨ Cor dinÃ¢mica
  function getUserColor(username) {
    let hash = 0;
    for (let i = 0; i < username.length; i++)
      hash = username.charCodeAt(i) + ((hash << 5) - hash);
    return `hsl(${hash % 360}, 70%, 60%)`;
  }

  function getPhotoByUsername(username) {
    if (username.toLowerCase() === "disteseach") return 'dist.jpg';
    if (username.toLowerCase() === "nid") return 'fotonid.jpeg';
    if (username.toLowerCase() === "distraction") return 'fotonid.jpeg';
    return 'disney.gif';
  }

  // ðŸ’¾ Salvar usuÃ¡rio
  const savedName = localStorage.getItem('chat_username');
  if (savedName) {
    usernameInput.value = savedName;
    usernameInput.readOnly = true;
    usernameInput.style.opacity = "0.6";
    ativarPresenca(savedName); // ðŸ”µ ativa presenÃ§a ao carregar
  }

  // ðŸ”µ FunÃ§Ã£o para ativar presenÃ§a
  function ativarPresenca(username) {
    const userStatusRef = ref(db, `presence/${username}`);

    set(userStatusRef, {
      online: true,
      lastSeen: serverTimestamp()
    });

    onDisconnect(userStatusRef).set({
      online: false,
      lastSeen: serverTimestamp()
    });
  }

  // ðŸ‘€ Escutar presenÃ§a
  let usuariosOnlineAnterior = [];

  onValue(presenceRef, (snapshot) => {
    const data = snapshot.val() || {};
    const onlineUsers = Object.keys(data).filter(u => data[u].online);

    // Atualiza tÃ­tulo
    chatTitle.textContent = onlineUsers.length
      ? `Online: ${onlineUsers.join(", ")}`
      : "Chat";

    // Detecta quem entrou
    onlineUsers.forEach(user => {
      if (!usuariosOnlineAnterior.includes(user)) {
        adicionarMensagemSistema(`ðŸ”µ ${user} entrou no chat`);
      }
    });

    // Detecta quem saiu
    usuariosOnlineAnterior.forEach(user => {
      if (!onlineUsers.includes(user)) {
        adicionarMensagemSistema(`âš« ${user} saiu do chat`);
      }
    });

    usuariosOnlineAnterior = onlineUsers;
  });

  function adicionarMensagemSistema(texto) {
    const div = document.createElement("div");
    div.classList.add("system-message"); // â† adiciona a classe
    div.style.textAlign = "center";
    div.style.fontSize = "0.8rem";
    div.style.opacity = "0.6";
    div.style.color = "#00ffcc";
    div.textContent = texto;
    messagesArea.appendChild(div);
    messagesArea.scrollTop = messagesArea.scrollHeight;
  }

  // ðŸ“¤ Enviar mensagem
  chatForm.addEventListener('submit', (e) => {
    e.preventDefault();

    const username = usernameInput.value.trim();
    const message = messageInput.value.trim();

    if (!username) return alert("Digite seu nome.");
    if (!podeVerTudo(username)) return alert("VocÃª nÃ£o tem permissÃ£o para enviar mensagens.");
    if (!message) return;

    if (!savedName) {
      localStorage.setItem('chat_username', username);
      usernameInput.readOnly = true;
      usernameInput.style.opacity = "0.6";
      ativarPresenca(username);
    }

    push(messagesRef, {
      username,
      text: message,
      timestamp: serverTimestamp()
    });

    messageInput.value = '';
    set(ref(db, `typing/${username}`), false);
  });

  // ðŸ“¥ Receber mensagens
onChildAdded(messagesRef, (data) => {
  const msg = data.val();
  if (!msg) return;

  const currentUser = usernameInput.value.trim();

  // âš¡ NUDGE: tremer chat nos outros usuÃ¡rios
  if (msg.type === "nudge") {
    if (msg.from !== currentUser) {
      // Tremer o chat
      messagesArea.classList.add('shake');
      setTimeout(() => messagesArea.classList.remove('shake'), 500);

      // Som de notificaÃ§Ã£o
      notificationSound.play().catch(() => {});

      // Opcional: vibraÃ§Ã£o se o dispositivo permitir
      if ("vibrate" in navigator) navigator.vibrate([300,100,300]);
    }
    return; // nÃ£o adiciona no chat visualmente
  }

  // ðŸ”¹ Mensagem normal
  if (!podeVerTudo(currentUser)) return;

  const messageElement = document.createElement('div');
  messageElement.classList.add('message');

  let time = "--:--";
  if (msg.timestamp)
    time = new Date(msg.timestamp)
      .toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

  const userColor = getUserColor(msg.username);
  const photoURL = getPhotoByUsername(msg.username);

  messageElement.innerHTML = `
    <img src="${photoURL}" alt="avatar">
    <div class="message-content" style="border-left:4px solid ${userColor}; padding-left:8px;">
      <div style="display:flex; justify-content:space-between;">
        <span style="font-weight:bold; color:${userColor};">${msg.username}</span>
        <span style="font-size:0.7rem; opacity:0.6;">${time}</span>
      </div>
      <div style="color:#fff;">
        ${msg.text || ""}
        ${msg.audioURL ? `<audio controls src="${msg.audioURL}"></audio>` : ""}
        ${msg.imageURL ? `<img src="${msg.imageURL}" class="chat-image" style="max-width:300px; display:block; margin-top:5px; cursor:pointer;">` : ""}
      </div>
    </div>
  `;

  // Som + vibraÃ§Ã£o se for outra pessoa
  if (msg.username !== currentUser) {
    notificationSound.play().catch(() => {});
    if ("vibrate" in navigator) navigator.vibrate([500,200,500]);
    if (Notification.permission === "granted" && document.hidden) {
      new Notification(`Nova mensagem de ${msg.username}`, { body: msg.text || "Nova mÃ­dia recebida" });
    }
  }

  // Expandir imagem
 const previewModal = document.getElementById('preview-modal');
const previewImage = document.getElementById('preview-image');
const previewVideo = document.getElementById('preview-video');
const closePreview = document.getElementById('close-preview');

messageElement.querySelectorAll('.chat-image').forEach(img => {
  img.addEventListener('click', () => {
    if(img.src.endsWith(".mp4") || img.src.endsWith(".webm")) {
      previewImage.style.display = "none";
      previewVideo.src = img.src;
      previewVideo.style.display = "block";
    } else {
      previewVideo.style.display = "none";
      previewImage.src = img.src;
      previewImage.style.display = "block";
    }
    previewModal.classList.add('show');
  });
});

// Fechar modal
closePreview.addEventListener('click', () => {
  previewModal.classList.remove('show');
  previewImage.src = "";
  previewVideo.src = "";
});

// Fechar clicando fora da imagem/video
previewModal.addEventListener('click', (e) => {
  if(e.target === previewModal) {
    previewModal.classList.remove('show');
    previewImage.src = "";
    previewVideo.src = "";
  }
});

  messagesArea.appendChild(messageElement);
  messagesArea.scrollTo({ top: messagesArea.scrollHeight, behavior: 'smooth' });
});

  // âœï¸ Digitando
  let typingTimeout;
  messageInput.addEventListener('input', () => {
    const username = usernameInput.value.trim();
    if (!username) return;

    set(ref(db, `typing/${username}`), true);

    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
      set(ref(db, `typing/${username}`), false);
    }, 2000);
  });

  onValue(typingRef, (snapshot) => {
    const typingData = snapshot.val() || {};
    const currentUser = usernameInput.value;

    const typingUsers = Object.keys(typingData)
      .filter(u => u !== currentUser && typingData[u] === true);

    typingIndicator.textContent =
      typingUsers.length === 1
        ? `${typingUsers[0]} estÃ¡ digitando...`
        : typingUsers.length > 1
          ? `${typingUsers.join(", ")} estÃ£o digitando...`
          : "";

    if (typingUsers.length > 0)
      typingSound.play().catch(() => {});
  });

  // ðŸ“Ž Enviar imagem
  imageBtn.addEventListener("click", () => imageInput.click());

  imageInput.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const username = usernameInput.value.trim();
    if (!username || !podeVerTudo(username)) return;

    const fileRef = storageRef(storage, `images/${Date.now()}_${file.name}`);
    await uploadBytes(fileRef, file);
    const downloadURL = await getDownloadURL(fileRef);

    push(messagesRef, {
      username,
      imageURL: downloadURL,
      timestamp: serverTimestamp()
    });
  });

  // ðŸŽ¤ Gravar Ã¡udio
  let mediaRecorder;
  let audioChunks = [];

  recordBtn.addEventListener("click", async () => {
    const username = usernameInput.value.trim();
    if (!username || !podeVerTudo(username)) return;

    if (!mediaRecorder || mediaRecorder.state === "inactive") {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.start();
      recordBtn.textContent = "â¹ï¸ Parar";

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

      mediaRecorder.onstop = async () => {
        const blob = new Blob(audioChunks, { type: "audio/webm" });
        audioChunks = [];

        const fileRef = storageRef(storage, `audios/${Date.now()}.webm`);
        await uploadBytes(fileRef, blob);
        const downloadURL = await getDownloadURL(fileRef);

        push(messagesRef, {
          username,
          audioURL: downloadURL,
          timestamp: serverTimestamp()
        });

        recordBtn.textContent = "ðŸŽ¤ Gravar";
      };
    } else {
      mediaRecorder.stop();
    }
  });

  // âš¡ BotÃ£o Nudge / AtenÃ§Ã£o
const nudgeBtn = document.getElementById('nudge-btn');
// âš¡ BotÃ£o Nudge / AtenÃ§Ã£o para todos
nudgeBtn.addEventListener('click', () => {
  const username = usernameInput.value.trim();
  if (!username || !podeVerTudo(username)) return;

  // Envia um "nudge" para todos via Firebase
  push(messagesRef, {
    type: "nudge",
    from: username,
    timestamp: serverTimestamp()
  });

  notificationSound.play().catch(() => {});
if ("vibrate" in navigator) navigator.vibrate([500,200,500]);
});

});


</script>

</body>
</html>