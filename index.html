<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="chat-container">
    <header>
        <h1>Chat</h1>
    </header>
    <div id="chat-messages" class="messages-area">
        <!-- As mensagens aparecer칚o aqui -->
    </div>
    <form id="chat-form" novalidate>
        <input type="text" id="username" placeholder="Seu nome">
        <div class="input-group">
            <input type="text" id="message-input" placeholder="Digite sua mensagem...">
            <button type="submit">Enviar</button>
        </div>
    </form>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { 
  getDatabase, 
  ref, 
  push, 
  onChildAdded, 
  serverTimestamp,
  set,
  onDisconnect,
  onValue
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

document.addEventListener('DOMContentLoaded', () => {

  // 游댒 Permiss칚o para notifica칞칫es
  if (Notification.permission === "default") {
    Notification.requestPermission().then(permission => {
      console.log("Permiss칚o de notifica칞칚o:", permission);
    });
  }

  // 游댒 Sons
  const notificationSound = new Audio('som.mp3'); // som de nova mensagem
  const typingSound = new Audio('typing.mp3'); // som de digita칞칚o
  typingSound.volume = 0.3;

  // 游댠 CONFIG FIREBASE
  const firebaseConfig = {
    apiKey: "AIzaSyBuiBi8B3Sf6hZfLOYd9Ezl6IXw8NbbF1A",
    authDomain: "mextill.firebaseapp.com",
    databaseURL: "https://mextill-default-rtdb.firebaseio.com",
    projectId: "mextill",
    storageBucket: "mextill.firebasestorage.app",
    messagingSenderId: "811140414542",
    appId: "1:811140414542:web:e695c35ec6d0cdf523571f",
    measurementId: "G-7D3J6PQVZM"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const messagesRef = ref(db, 'messages');
  const connectedRef = ref(db, ".info/connected");
  const typingRef = ref(db, 'typing');

  // 游댳 Elementos DOM
  const chatForm = document.getElementById('chat-form');
  const messageInput = document.getElementById('message-input');
  const usernameInput = document.getElementById('username');
  const messagesArea = document.getElementById('chat-messages');

  // =============================
  // 游댠 FUN칂츾O PARA CORES POR USU츼RIO
  // =============================
  function getUserColor(username) {
    let hash = 0;
    for (let i = 0; i < username.length; i++) {
      hash = username.charCodeAt(i) + ((hash << 5) - hash);
    }
    const color = `hsl(${hash % 360}, 70%, 60%)`;
    return color;
  }

  // =============================
  // 游댠 ATIVAR STATUS ONLINE
  // =============================
  function activateUserStatus(username) {
    const userStatusRef = ref(db, 'users/' + username);
    onValue(connectedRef, (snap) => {
      if (snap.val() === true) {
        set(userStatusRef, { online: true, lastSeen: serverTimestamp() });
        onDisconnect(userStatusRef).update({ online: false, lastSeen: serverTimestamp() });
      }
    });
  }

  // =============================
  // 游댠 CARREGAR NOME SALVO
  // =============================
  const savedName = localStorage.getItem('chat_username');
  if (savedName) {
    usernameInput.value = savedName;
    usernameInput.readOnly = true;
    usernameInput.style.opacity = "0.6";
    activateUserStatus(savedName);
  }

  // =============================
  // 游댠 ENVIAR MENSAGEM
  // =============================
  chatForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const message = messageInput.value.trim();
    const username = usernameInput.value.trim();
    if (!username) { alert("Por favor, digite seu nome."); return; }
    if (!message) return;

    if (!savedName) {
      localStorage.setItem('chat_username', username);
      usernameInput.readOnly = true;
      usernameInput.style.opacity = "0.6";
      activateUserStatus(username);
    }

    push(messagesRef, {
      username: username,
      text: message,
      timestamp: serverTimestamp()
    });

    // Limpa input e remove status digitando
    messageInput.value = '';
    set(ref(db, `typing/${username}`), false);
  });

  // =============================
  // 游댠 MONITORAR STATUS DE USU츼RIOS
  // =============================
  const userStatusRefs = {};
  function monitorUserStatus(username, statusDiv) {
    if (userStatusRefs[username]) return;
    const statusRef = ref(db, 'users/' + username);
    onValue(statusRef, (snapshot) => {
      const userData = snapshot.val();
      if (!userData) return;
      if (userData.online) statusDiv.innerHTML = "游릭 Online";
      else if (userData.lastSeen) {
        const date = new Date(userData.lastSeen);
        statusDiv.innerHTML = "Visto 맙 " + date.toLocaleTimeString('pt-BR', { hour:'2-digit', minute:'2-digit' });
      }
    });
    userStatusRefs[username] = true;
  }

  // =============================
  // 游댠 RECEBER MENSAGENS
  // =============================
  onChildAdded(messagesRef, (data) => {
    const msg = data.val();
    if (!msg) return;

    const messageElement = document.createElement('div');
    messageElement.classList.add('message');

    let time = "--:--";
    if (msg.timestamp) {
      const date = new Date(msg.timestamp);
      time = date.toLocaleTimeString('pt-BR', { hour:'2-digit', minute:'2-digit' });
    }

    const userColor = getUserColor(msg.username);

    messageElement.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:baseline;">
        <div>
          <span class="user" style="font-weight:bold; color:${userColor};">
            ${msg.username}
          </span>
          <div class="status" style="font-size:0.65rem; opacity:0.7;"></div>
        </div>
        <span style="font-size:0.7rem; opacity:0.6;">${time}</span>
      </div>
      <div style="color:#fff;">${msg.text}</div>
    `;
    messageElement.style.borderLeft = `4px solid ${userColor}`;
    messageElement.style.paddingLeft = "8px";
    messageElement.style.marginBottom = "6px";

    messagesArea.appendChild(messageElement);
    messagesArea.scrollTo({ top: messagesArea.scrollHeight, behavior: 'smooth' });

    // 游댒 Notifica칞칚o
    const isMyMessage = msg.username === usernameInput.value;
    if (!isMyMessage && Notification.permission === "granted" && document.hidden) {
      new Notification(`Nova mensagem de ${msg.username}`, { body: msg.text });
      notificationSound.play().catch(() => {});
    }

    // 游댳 Status online
    const statusDiv = messageElement.querySelector(".status");
    monitorUserStatus(msg.username, statusDiv);
  });

  // =============================
  // 游댠 INDICADOR "DIGITANDO..."
  // =============================
  // 游댠 INDICADOR "DIGITANDO..."
const typingIndicator = document.createElement('div');
typingIndicator.id = "typing-indicator";
typingIndicator.style.fontStyle = "italic";
typingIndicator.style.opacity = "0.7";
typingIndicator.style.margin = "4px 0";
messagesArea.appendChild(typingIndicator);

let typingTimeout;

// Evento ao digitar
messageInput.addEventListener('input', () => {
  const username = usernameInput.value.trim();
  if (!username) return;

  // Marca que est치 digitando
  set(ref(db, `typing/${username}`), true);

  // Limpa timeout anterior e adiciona 2s para reset
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(() => {
    set(ref(db, `typing/${username}`), false);
  }, 2000);
});

// Escuta todos os usu치rios digitando
onValue(typingRef, (snapshot) => {
  const typingData = snapshot.val() || {};
  // Pega apenas os outros usu치rios que est칚o digitando
  const otherUsersTyping = Object.keys(typingData)
    .filter(user => user !== usernameInput.value && typingData[user] === true);

  if (otherUsersTyping.length > 0) {
    // Plural ou singular
    const texto = otherUsersTyping.length === 1 
      ? `${otherUsersTyping[0]} est치 digitando...`
      : `${otherUsersTyping.join(", ")} est칚o digitando...`;
    typingIndicator.textContent = texto;
    typingSound.play().catch(() => {});
  } else {
    typingIndicator.textContent = "";
  }
});


});
</script>
</body>
</html>
